<!-- Sendell Dialog - Centralized Dialog System -->
<!-- v1.0: Supports centered and character-attached modes -->
<!-- v5.1: Added loading bar and welcome phases -->
<!-- v2.0: Added AI chat mode post-onboarding -->

@if (isVisible()) {
  <div class="dialog-wrapper"
       [class.centered]="isCentered"
       [class.chat-mode]="isChatMode()"
       [ngStyle]="getPositionStyle()">

    <div class="dialog-box"
         [class.choice-mode]="requiresChoice()"
         [class.loading-mode]="isLoading()"
         [class.welcome-mode]="isWelcome()"
         [class.chat-mode]="isChatMode()">

      <div class="dialog-content">
        <!-- Terminal Header -->
        <!-- v8.0 PHASE 1: Simplified header - MODO SMART indicator -->
        <div class="dialog-header">
          <span class="dialog-indicator ai-active"></span>
          <span class="dialog-title">// SENDELL</span>
          @if (isChatMode()) {
            <span class="ai-status" [class.ready]="chatStatusClass() === 'consultant'" [class.smart-mode]="chatStatusClass() === 'smart'" [class.connecting-mode]="chatStatusClass() === 'connecting'">
              <span class="status-text">{{ chatStatusText() }}</span>
            </span>
          }
        </div>

        <!-- v8.0 PHASE 1: Simplified Loading + Welcome Section (no LLM info) -->
        @if (isLoading() || isWelcome()) {
          <div class="loading-welcome-section">
            <!-- Content that transitions smoothly -->
            <div class="content-transition-wrapper">
              @if (isLoading()) {
                <div class="loading-content">
                  <div class="loading-text">{{ loadingText }}</div>
                  <div class="loading-bar-container">
                    <div class="loading-bar" [style.width.%]="loadingProgress()"></div>
                  </div>
                  <div class="loading-percent">{{ loadingProgress() | number:'1.0-0' }}%</div>
                </div>
              }

              @if (isWelcome()) {
                <div class="welcome-content">
                  <div class="welcome-text">{{ welcomeText }}</div>
                  <div class="welcome-hint blink">[PULSE CUALQUIER TECLA]</div>
                </div>
              }
            </div>
          </div>
        }

        <!-- v8.0 PHASE 1: Removed AI download indicators - smart responses are instant -->

        <!-- v9.0: User message bubble (shown above AI response in chat mode) -->
        @if (isChatMode() && lastUserMessage()) {
          <div class="user-message-bubble">
            <span class="user-label">TÚ &gt;</span>
            <span class="user-text">{{ lastUserMessage() }}</span>
          </div>
        }

        <!-- Dialog Text with Typing Effect -->
        <!-- v9.0: Streaming shows cursor, processing shows dots -->
        @if (!isLoading() && !isWelcome() && (displayedText() || isTyping() || isAITyping())) {
          <div class="dialog-text" [class.chat-response]="isChatMode()">
            @if (isAITyping() && !isTyping()) {
              <!-- Processing indicator (before first chunk arrives) -->
              <span class="loading-text">{{ displayedText() }}</span>
              <span class="loading-dots">
                <span class="dot">.</span>
                <span class="dot">.</span>
                <span class="dot">.</span>
              </span>
            } @else {
              <span class="typing-effect">{{ displayedText() }}</span>
              @if (isTyping()) {
                <span class="cursor">_</span>
              }
            }
          </div>
        }

        <!-- v5.4.3: Choice Buttons (Tour vs Free) - visual buttons instead of Y/N -->
        @if (requiresChoice() && !isTyping() && !isChatMode()) {
          <div class="dialog-choice-section">
            <button
              class="choice-button tour-button"
              (click)="selectTourChoice(true)">
              Sí, guíame
            </button>
            <button
              class="choice-button free-button"
              (click)="selectTourChoice(false)">
              Explorar solo
            </button>
          </div>
        }

        <!-- v2.0: Chat Input (post-onboarding) -->
        <!-- v2.1: Only shown after double-click on dialog -->
        <!-- v5.5: Improved with maxlength, counter, and send button -->
        @if (isChatMode() && showChatInput() && isOnboardingComplete() && !isTourInProgress()) {
          <div class="chat-input-section">
            <div class="chat-input-wrapper">
              <span class="input-prompt">&gt; </span>
              <input
                #chatInputEl
                type="text"
                class="chat-input"
                [(ngModel)]="chatUserInput"
                (keydown)="onChatKeydown($event)"
                (click)="onChatInputClick($event)"
                (focus)="onInputFocus()"
                (blur)="onInputBlur()"
                placeholder="Pregúntame algo..."
                autocomplete="off"
                spellcheck="false"
                maxlength="200">
              <button
                class="send-btn"
                (click)="submitChat()"
                [disabled]="!chatUserInput.trim()"
                title="Enviar">
                ▶
              </button>
            </div>
            <div class="chat-footer">
              <span class="char-counter" [class.near-limit]="chatUserInput.length > 180">
                {{ chatUserInput.length }}/200
              </span>
              <span class="chat-hint">ENTER para enviar</span>
            </div>
          </div>
        }

        <!-- v5.2.5: Double-click hint REMOVED - behavior is now implicit -->
        <!-- User can double-click Sendell to open chat, but no visible hint -->

        <!-- v5.2.5: Tour Continue Prompt -->
        @if (showTourContinuePrompt()) {
          <div class="dialog-prompt">
            <span class="blink">[CUALQUIER TECLA PARA CONTINUAR]</span>
          </div>
        }

        <!-- v5.8: Chat Continue Prompt (after AI responds in free chat) -->
        @if (showChatContinuePrompt()) {
          <div class="dialog-prompt">
            <span class="blink">[CUALQUIER TECLA]</span>
          </div>
        }

        <!-- Continue Prompt (only during onboarding) -->
        @if (showContinuePrompt()) {
          <div class="dialog-prompt">
            <span class="blink">[CUALQUIER TECLA]</span>
          </div>
        }
      </div>

      <!-- Arrow pointing to character (only when not centered) -->
      <!-- v5.9.1: Arrow direction changes based on dialog position -->
      @if (!isCentered) {
        @if (isDialogOnLeft()) {
          <div class="dialog-arrow-right"></div>
        } @else {
          <div class="dialog-arrow-left"></div>
        }
      }
    </div>
  </div>
}

<!-- v5.5: Minimized state - controlled by double-click on Sendell robot -->
